<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚»ãƒ³ã‚¿ãƒ¼å—æ ¡ ç™»æ ¡ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; }
        .calendar-day { transition: all 0.3s ease; }
        .calendar-day.checked { background-color: #fef08a; color: #b45309; font-weight: 800; border-radius: 50%; position: relative; }
        .calendar-day.checked::after { content: 'âœ”'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5em; color: #f59e0b; }
        .calendar-day.today { border: 2px solid #3b82f6; }
        .btn-shine { position: relative; overflow: hidden; }
        .btn-shine::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: rgba(255, 255, 255, 0.4); transform: rotate(45deg); transition: all 0.5s ease; opacity: 0; }
        .btn-shine:hover::after { left: 100%; opacity: 1; transition: all 0.5s ease; }
    </style>
</head>
<body class="bg-blue-50 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8">
        <div id="login-screen">
            <h1 class="text-3xl font-extrabold text-center text-blue-600 mb-2 leading-tight">ã‚»ãƒ³ã‚¿ãƒ¼å—æ ¡<br>ç™»æ ¡ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h1>
            <p class="text-center text-gray-500 mb-8">IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼</p>
            <div class="space-y-4">
                <input type="text" id="username" placeholder="ID" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
            </div>
            <button onclick="login()" class="w-full mt-8 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 btn-shine">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <p id="login-error" class="text-red-500 text-center mt-4 h-5"></p>
        </div>

        <div id="main-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <div><h2 class="text-2xl font-bold text-gray-800">ã“ã‚“ã«ã¡ã¯ã€<span id="user-name"></span> ã•ã‚“ï¼</h2><p class="text-gray-500">ä»Šæ—¥ã‚‚ãŒã‚“ã°ã‚ã†ï¼</p></div>
                <button onclick="logout()" class="text-sm text-gray-500 hover:text-red-500 transition-colors">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            
            <div class="bg-blue-100 rounded-lg p-4 text-center mb-6">
                <p class="text-blue-800 text-sm">åˆè¨ˆç™»æ ¡æ—¥æ•°</p>
                <p class="text-3xl font-extrabold text-blue-600"><span id="login-count">0</span> æ—¥</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <button id="toko-btn" onclick="recordAttendance('toko')" class="bg-green-500 text-white font-bold py-4 rounded-lg hover:bg-green-600 transition-all duration-300 transform hover:scale-105 btn-shine disabled:opacity-50 disabled:cursor-not-allowed">ç™»æ ¡ã™ã‚‹</button>
                <button id="geko-btn" onclick="recordAttendance('geko')" class="bg-orange-500 text-white font-bold py-4 rounded-lg hover:bg-orange-600 transition-all duration-300 transform hover:scale-105 btn-shine disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹æ ¡ã™ã‚‹</button>
            </div>
            
            <div id="announcements-container" class="space-y-3 mb-6">
            </div>
            
            <div class="mt-2 mb-6">
                <button id="study-plus-link" class="block w-full bg-indigo-500 text-white font-bold py-3 rounded-lg text-center hover:bg-indigo-600 transition-all duration-300 transform hover:scale-105 btn-shine">
                    Study Plusã¯ã“ã¡ã‚‰
                </button>
            </div>

            <div id="calendar" class="bg-gray-50 p-4 rounded-lg mb-8">
                <div class="flex justify-between items-center mb-4"><button id="prev-month" class="text-gray-600 hover:text-blue-500">&lt;</button><h3 id="calendar-header" class="text-lg font-bold text-gray-700"></h3><button id="next-month" class="text-gray-600 hover:text-blue-500">&gt;</button></div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
            </div>

            <div class="border-t-2 border-gray-100 pt-6">
                <button onclick="openEmergencyModal()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition-all duration-300 shadow-md">
                    ğŸš¨ ç·Šæ€¥é€£çµ¡
                </button>
                <p class="text-xs text-gray-500 text-center mt-2">ç„¡äººé–‹é¤¨æ™‚ã®ãƒˆãƒ©ãƒ–ãƒ«ã®éš›ãªã©ã«ã”æ´»ç”¨ãã ã•ã„</p>
            </div>

            <div id="next-visit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 px-4">
                <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸ‘‹</h3>
                    <p class="text-gray-600 mb-4 text-sm text-center">æ¬¡å›ã®ç™»æ ¡äºˆå®šã‚’æ•™ãˆã¦ã­<br><span class="text-xs text-blue-500">â€»æ˜æ—¥ä»¥é™ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</span></p>
                    
                    <div class="mb-6">
                        <label for="next-visit-input" class="block text-gray-700 text-sm font-bold mb-2">æ—¥æ™‚é¸æŠ</label>
                        <input type="datetime-local" id="next-visit-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-gray-50 text-lg">
                    </div>

                    <div class="flex space-x-3 mb-4">
                        <button onclick="closeNextVisitModal()" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button onclick="submitNextVisit()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-md transition-transform transform hover:scale-105">æ±ºå®šã—ã¦ä¸‹æ ¡</button>
                    </div>

                    <div class="border-t pt-4">
                        <button onclick="submitLineLater()" class="block w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 shadow-md transition-transform transform hover:scale-105 btn-shine text-sm leading-tight">
                            ã„ã¤æ¥ã‚Œã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã®ã§<br>ã‚ã¨ã§LINEã§é€ã‚‹
                        </button>
                    </div>
                </div>
            </div>

            <div id="emergency-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 px-4">
                <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-100">
                    <h3 class="text-xl font-bold text-red-600 mb-2 text-center">ğŸš¨ ç·Šæ€¥é€£çµ¡</h3>
                    <p class="text-gray-600 mb-4 text-sm text-center">ã‚¹ã‚¿ãƒƒãƒ•ã«é€šçŸ¥ã‚’é€ã‚Šã¾ã™ã€‚<br>è¦ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                    
                    <div class="mb-6">
                        <textarea id="emergency-detail" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-red-500 bg-gray-50" placeholder="ä¾‹ï¼šéµãŒé–‹ã„ã¦ã„ã¾ã›ã‚“ã€ã‚³ãƒ”ãƒ¼æ©ŸãŒè©°ã¾ã‚Šã¾ã—ãŸã€ãªã©"></textarea>
                    </div>

                    <div class="flex space-x-3">
                        <button onclick="closeEmergencyModal()" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button onclick="submitEmergency()" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 shadow-md transition-transform transform hover:scale-105">é€ä¿¡ã™ã‚‹</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbw9Uzp2tnUKpLxUv_8MOBT6cffjCMO91yXL1F3WSRK44DN3BCBY0YiCxpdfrWIgKWOT/exec'; 
        const STUDY_PLUS_BASE_URL = 'https://fs-platform.studyplus.co.jp/auth/student?redirect_uri=https%3A%2F%2Fcontents.studyplus.co.jp%2Fenter_exit%2F6dccd60b94&fallback_uri=https%3A%2F%2Fcontents.studyplus.co.jp%2Faccess_error&expires_at=2025-08-10T09%3A10%3A58.934Z';

        // â˜… æ–°æ©Ÿèƒ½è¨­å®šï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã¨ä½ç½®æƒ…å ±
        const STORAGE_KEY = 'stamp_rally_user_v1';
        // ã‚»ãƒ³ã‚¿ãƒ¼å—æ ¡ï¼ˆç¬¬2ãƒ•ãƒ­ãƒ¼ãƒªãƒƒã‚·ãƒ¥ãƒ“ãƒ«ï¼‰
        const SCHOOL_LAT = 35.5462481;
        const SCHOOL_LNG = 139.5737649;
        const ALLOWED_DISTANCE_M = 150; // è¨±å®¹åŠå¾„150mï¼ˆGPSèª¤å·®è€ƒæ…®ï¼‰

        let currentUser = null;
        let currentMonth = new Date();
        let attendanceDates = [];
        let hasLeftToday = false;
        let lastCheckedDate = null;
        let loginExpiryTimestamp = null;
        let expiryTimer = null;

        // ä½ç½®æƒ…å ±ç®¡ç†
        let cachedPosition = null;
        let isLocationReady = false;

        const loginScreen = document.getElementById('login-screen');
        const mainScreen = document.getElementById('main-screen');
        const loginError = document.getElementById('login-error');
        const userNameEl = document.getElementById('user-name');
        const loginCountEl = document.getElementById('login-count');
        const tokoBtn = document.getElementById('toko-btn');
        const gekoBtn = document.getElementById('geko-btn');
        const studyPlusLinkBtn = document.getElementById('study-plus-link');
        
        const nextVisitModal = document.getElementById('next-visit-modal');
        const nextVisitInput = document.getElementById('next-visit-input');
        const emergencyModal = document.getElementById('emergency-modal');
        const emergencyDetail = document.getElementById('emergency-detail');

        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const qrLoginDataStr = urlParams.get('qr_login_data');

            // 1. QRãƒ­ã‚°ã‚¤ãƒ³å„ªå…ˆ
            if (qrLoginDataStr) {
                try {
                    const decodedData = decodeURIComponent(qrLoginDataStr);
                    const result = JSON.parse(decodedData);
                    showMainScreen(result, false); // QRã¯æœ€æ–°ãƒ‡ãƒ¼ã‚¿ãªã®ã§ä¿å­˜ã™ã‚‹
                    window.history.replaceState(null, '', window.location.pathname);
                    return;
                } catch (e) {
                    console.error("QRãƒ­ã‚°ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚", e);
                    loginError.textContent = "QRã‚³ãƒ¼ãƒ‰ã®ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚";
                }
            }

            // 2. è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³åˆ¤å®šï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèªï¼‰
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    const now = new Date().getTime();
                    // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ï¼ˆæœŸé™åˆ‡ã‚Œãªã‚‰å†ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã‚‹ï¼‰
                    if (parsedData.expiryTimestamp && now < parsedData.expiryTimestamp) {
                        console.log("â˜… è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ (Cache Hit)");
                        showMainScreen(parsedData, true); // true = ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨
                        return;
                    } else {
                        console.log("ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™åˆ‡ã‚Œã®ãŸã‚è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã‚¹ã‚­ãƒƒãƒ—");
                        localStorage.removeItem(STORAGE_KEY);
                    }
                } catch (e) {
                    console.error("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å¤±æ•—", e);
                    localStorage.removeItem(STORAGE_KEY);
                }
            }
        });

        // è·é›¢è¨ˆç®—ï¼ˆãƒãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ³ã®å…¬å¼ï¼‰
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // åœ°çƒã®åŠå¾„ (m)
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lng2-lng1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ä½ç½®æƒ…å ±ã®å…ˆèª­ã¿é–‹å§‹ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã«å‘¼ã¶ï¼‰
        function startLocationTracking() {
            if (!navigator.geolocation) {
                console.warn("ä½ç½®æƒ…å ±éå¯¾å¿œç«¯æœ«ã§ã™");
                return;
            }
            console.log("ä½ç½®æƒ…å ±ã®ç›£è¦–(Preload)ã‚’é–‹å§‹ã—ã¾ã™...");
            navigator.geolocation.watchPosition(
                (position) => {
                    cachedPosition = position;
                    isLocationReady = true;
                    // ãƒ‡ãƒãƒƒã‚°ç”¨: è·é›¢ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
                    // const dist = getDistance(position.coords.latitude, position.coords.longitude, SCHOOL_LAT, SCHOOL_LNG);
                    // console.log(`ç¾åœ¨åœ°æ›´æ–°: æ•™å®¤ã¾ã§ç´„${Math.round(dist)}m`);
                },
                (error) => {
                    console.warn("ä½ç½®æƒ…å ±ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å–å¾—ã«å¤±æ•—:", error.code);
                    isLocationReady = false;
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        function showMainScreen(result, isCache = false) {
            currentUser = result.user;
            attendanceDates = result.attendanceDates || [];
            hasLeftToday = result.hasLeftToday || false;
            
            userNameEl.textContent = currentUser.name;
            loginCountEl.textContent = attendanceDates.length;
            
            loginScreen.classList.add('hidden');
            mainScreen.classList.remove('hidden');
            
            // ãŠçŸ¥ã‚‰ã›è¡¨ç¤º
            const announcementsContainer = document.getElementById('announcements-container');
            announcementsContainer.innerHTML = ''; 
            if (result.announcements && result.announcements.length > 0) {
                let announcementsHtml = '<h3 class="text-xl font-bold text-gray-800 border-b-2 pb-2 mb-2">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</h3>';
                result.announcements.forEach(ann => {
                    const safeTitle = ann.title.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const safeContent = ann.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    announcementsHtml += `<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg shadow-sm"><h4 class="font-bold text-yellow-900">${safeTitle}</h4><p class="text-gray-700 mt-1 text-sm">${safeContent}</p></div>`;
                });
                announcementsContainer.innerHTML = announcementsHtml;
            }
            
            lastCheckedDate = new Date().toLocaleDateString();

            if (result.expiryTimestamp) { 
                loginExpiryTimestamp = result.expiryTimestamp;
                startExpiryTimer();
            }

            // â˜… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ãªã‘ã‚Œã°ä¿å­˜ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã‚‰ä½ç½®æƒ…å ±ç›£è¦–ã‚¹ã‚¿ãƒ¼ãƒˆ
            if (!isCache) {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(result));
                } catch(e) { console.error("Storage save error", e); }
            }

            // ç”»é¢è¡¨ç¤ºå®Œäº†ã—ãŸã‚‰ã€å³åº§ã«ä½ç½®æƒ…å ±ã‚’æ¢ã—ã«è¡Œã
            startLocationTracking();

            updateCalendar();
            updateButtonState();
            loginError.textContent = '';
        }

        function startExpiryTimer() {
            if (expiryTimer) clearInterval(expiryTimer);
            expiryTimer = setInterval(() => {
                if (!loginExpiryTimestamp) {
                    clearInterval(expiryTimer);
                    return;
                }
                const now = new Date().getTime();
                if (now > loginExpiryTimestamp) {
                    alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
                    logout();
                }
            }, 1000);
        }
        
        function checkDateAndLogout() {
            if (!currentUser) return;
            const today = new Date().toLocaleDateString();
            if (lastCheckedDate === null) lastCheckedDate = today;
            if (lastCheckedDate !== today) {
                alert("æ—¥ä»˜ãŒå¤‰ã‚ã‚Šã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
                logout();
            }
        }
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                checkDateAndLogout();
            }
        });

        function logout() {
            if (expiryTimer) clearInterval(expiryTimer);
            loginExpiryTimestamp = null;
            currentUser = null;
            attendanceDates = [];
            hasLeftToday = false;
            
            // â˜… ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
            localStorage.removeItem(STORAGE_KEY);
            cachedPosition = null;
            isLocationReady = false;

            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            mainScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        function generateDynamicStudyPlusUrl() {
            const originalUrl = new URL(STUDY_PLUS_BASE_URL);
            originalUrl.searchParams.delete('expires_at'); 
            const baseUrlWithoutOldExpiry = originalUrl.toString();
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5);
            const newExpiresAt = now.toISOString();
            return `${baseUrlWithoutOldExpiry}&expires_at=${encodeURIComponent(newExpiresAt)}`;
        }

        function redirectToStudyPlus() {
            const urlToOpen = generateDynamicStudyPlusUrl();
            window.open(urlToOpen, '_blank');
        }

        function jsonpRequest(url, callbackName, callback) {
            window[callbackName] = callback;
            const script = document.createElement('script');
            script.src = url;
            document.body.appendChild(script);
            script.onload = () => { document.body.removeChild(script); delete window[callbackName]; };
            script.onerror = () => { 
                loginError.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'; 
                document.body.removeChild(script); 
                delete window[callbackName]; 
            };
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            loginError.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
            if (!username || !password) { loginError.textContent = 'IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'; return; }
            const callbackName = 'loginCallback';
            const url = `${GAS_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&callback=${callbackName}`;
            jsonpRequest(url, callbackName, (result) => {
                if (result.success) {
                    showMainScreen(result, false); // æ–°è¦ãƒ­ã‚°ã‚¤ãƒ³ãªã®ã§ä¿å­˜ã™ã‚‹
                } else {
                    loginError.textContent = result.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                }
            });
        }

        // ç™»æ ¡ãƒ»ä¸‹æ ¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ï¼ˆGPSãƒã‚§ãƒƒã‚¯å…¥ã‚Šï¼‰
        function recordAttendance(type) {
            const btn = type === 'toko' ? tokoBtn : gekoBtn;
            
            // â€»ä¸‹æ ¡æ™‚ã‚‚å ´æ‰€ãƒã‚§ãƒƒã‚¯ã—ãŸã„å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã™ï¼ˆåŸºæœ¬ã¯ç™»æ ¡æ™‚ã®ã¿ãƒã‚§ãƒƒã‚¯ã§ååˆ†ãªå ´åˆãŒå¤šã„ãŒã€è¦ä»¶ã«åˆã‚ã›ã¦å…¨ãƒã‚§ãƒƒã‚¯ï¼‰
            // if (type === 'geko') { executeAttendance(type, null); return; }

            if (!navigator.geolocation) {
                alert("ãŠä½¿ã„ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }

            // â˜… ãƒ‘ã‚¿ãƒ¼ãƒ³A: æ—¢ã«è£ã§ä½ç½®æƒ…å ±ãŒå–ã‚Œã¦ã„ã‚‹ï¼ˆçˆ†é€Ÿï¼‰
            if (isLocationReady && cachedPosition) {
                checkDistanceAndExecute(cachedPosition, type, btn);
                return;
            }

            // â˜… ãƒ‘ã‚¿ãƒ¼ãƒ³B: ã¾ã å–ã‚Œã¦ã„ãªã„ï¼ˆã“ã“ã ã‘å¾…ãŸã›ã‚‹ï¼‰
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = "ä½ç½®ç¢ºèªä¸­...";

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    checkDistanceAndExecute(position, type, btn);
                },
                (error) => {
                    alert("ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nç«¯æœ«ã®è¨­å®šã§ä½ç½®æƒ…å ±ã®åˆ©ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
                    btn.disabled = false;
                    btn.textContent = originalText;
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        // è·é›¢åˆ¤å®šã¨å®Ÿè¡Œã®å…±é€šãƒ­ã‚¸ãƒƒã‚¯
        function checkDistanceAndExecute(position, type, btn) {
            const currentLat = position.coords.latitude;
            const currentLng = position.coords.longitude;
            const distance = getDistance(currentLat, currentLng, SCHOOL_LAT, SCHOOL_LNG);

            console.log(`æ•™å®¤ã¾ã§ã®è·é›¢: ç´„${Math.round(distance)}m`);

            if (distance <= ALLOWED_DISTANCE_M) {
                // è·é›¢OKãªã‚‰å®Ÿè¡Œ
                if (type === 'geko') {
                    // ä¸‹æ ¡å‡¦ç†ï¼ˆæ—¥æ™‚é¸æŠã¸ï¼‰
                    const now = new Date();
                    const tomorrow = new Date(now);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(0, 0, 0, 0);
                    const offset = tomorrow.getTimezoneOffset() * 60000;
                    const localTomorrowISO = (new Date(tomorrow.getTime() - offset)).toISOString().slice(0, 16);
                    nextVisitInput.min = localTomorrowISO;
                    nextVisitInput.value = ""; 
                    nextVisitModal.classList.remove('hidden');
                } else {
                    // ç™»æ ¡å‡¦ç†
                    executeAttendance('toko', null);
                }
            } else {
                alert(`æ•™å®¤ã‹ã‚‰é›¢ã‚Œã¦ã„ã¾ã™ï¼ˆç´„${Math.round(distance)}mï¼‰ã€‚\næ•™å®¤ã®ä¸­ã§æŠ¼ã—ã¦ãã ã•ã„ã€‚\n\nâ€»ä½ç½®æƒ…å ±ãŒãšã‚Œã¦ã„ã‚‹å ´åˆã¯ã€Wi-Fiã‚’ã‚ªãƒ³ã«ã™ã‚‹ã¨æ”¹å–„ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚`);
            }
        }

        function submitNextVisit() {
            const nextVisitVal = nextVisitInput.value;
            if (nextVisitVal && new Date(nextVisitVal) < new Date(nextVisitInput.min)) {
                alert("æ˜æ—¥ä»¥é™ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            nextVisitModal.classList.add('hidden');
            executeAttendance('geko', nextVisitVal);
        }

        function submitLineLater() {
            nextVisitModal.classList.add('hidden');
            executeAttendance('geko', 'LINEã§é€£çµ¡');
        }

        function closeNextVisitModal() {
            nextVisitModal.classList.add('hidden');
        }

        function executeAttendance(type, nextVisitDate) {
            const button = type === 'toko' ? tokoBtn : gekoBtn;
            button.disabled = true;
            button.textContent = 'è¨˜éŒ²ä¸­...'; 

            const callbackName = 'attendanceCallback';
            let url = `${GAS_URL}?action=recordAttendance&userId=${encodeURIComponent(currentUser.id)}&type=${type}&callback=${callbackName}`;
            if (nextVisitDate) {
                url += `&nextVisit=${encodeURIComponent(nextVisitDate)}`;
            }

            jsonpRequest(url, callbackName, (result) => {
                if (result.success) {
                    console.log("è¨˜éŒ²æˆåŠŸ: ", type);
                    if (type === 'toko') {
                        attendanceDates = result.attendanceDates;
                        // â˜… é‡è¦ï¼šè¨˜éŒ²æˆåŠŸã—ãŸã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚æ›´æ–°ã—ã¦ãŠã
                        currentUser.attendanceDates = attendanceDates; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨æ§‹é€ ã«åˆã‚ã›ã¦é©å®œèª¿æ•´
                        // ç°¡æ˜“çš„ã«å…¨ãƒ‡ãƒ¼ã‚¿å†å–å¾—ã¯ã§ããªã„ã®ã§ã€ä»Šå›ã¯ãƒªãƒ­ãƒ¼ãƒ‰ã‚’ä¿ƒã™ã‹ã€
                        // ã‚‚ã—ãã¯è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã§æ¬¡å›æ›´æ–°ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤æ–¹é‡ã¨ã™ã‚‹
                        // ï¼ˆå³å¯†ã«ã™ã‚‹ãªã‚‰ã“ã“ã§ result ã‚’ãƒãƒ¼ã‚¸ã—ã¦ setItem ã™ã‚‹ï¼‰
                        
                        // ç°¡æ˜“ãƒãƒ¼ã‚¸ã—ã¦ä¿å­˜
                        const savedData = localStorage.getItem(STORAGE_KEY);
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            data.attendanceDates = result.attendanceDates;
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                        }
                    } else if (type === 'geko') {
                        hasLeftToday = true;
                        // ç°¡æ˜“ãƒãƒ¼ã‚¸ã—ã¦ä¿å­˜
                        const savedData = localStorage.getItem(STORAGE_KEY);
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            data.hasLeftToday = true;
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                        }
                    }
                    updateCalendar();
                    updateButtonState();
                } else {
                    console.error("è¨˜éŒ²å¤±æ•—: ", result.message);
                    alert(result.message || 'è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    button.disabled = false;
                    button.textContent = (type === 'toko' ? 'ç™»æ ¡ã™ã‚‹' : 'ä¸‹æ ¡ã™ã‚‹');
                }
            });

            redirectToStudyPlus();
        }

        function openEmergencyModal() {
            emergencyDetail.value = '';
            emergencyModal.classList.remove('hidden');
        }
        
        function closeEmergencyModal() {
            emergencyModal.classList.add('hidden');
        }

        function submitEmergency() {
            const detail = emergencyDetail.value;
            if (!detail) {
                alert("è¦ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            const callbackName = 'emergencyCallback';
            const url = `${GAS_URL}?action=emergency&userId=${encodeURIComponent(currentUser.id)}&detail=${encodeURIComponent(detail)}&callback=${callbackName}`;
            
            alert("ç·Šæ€¥é€£çµ¡ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\nï¼ˆç¢ºèªã®ãŸã‚OKã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰");
            closeEmergencyModal();
            
            jsonpRequest(url, callbackName, (result) => {
                if (result.success) {
                    console.log("ç·Šæ€¥é€£çµ¡é€ä¿¡æˆåŠŸ");
                } else {
                    console.error("ç·Šæ€¥é€£çµ¡é€ä¿¡å¤±æ•—");
                }
            });
        }

        function updateButtonState() {
            const todayStr = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            const hasAttendedToday = attendanceDates.includes(todayStr);
            tokoBtn.disabled = hasAttendedToday;
            tokoBtn.textContent = 'ç™»æ ¡ã™ã‚‹'; // æˆ»ã™
            gekoBtn.disabled = !hasAttendedToday || hasLeftToday;
            gekoBtn.textContent = 'ä¸‹æ ¡ã™ã‚‹'; // æˆ»ã™
        }

        function updateCalendar() {
            const calendarHeader = document.getElementById('calendar-header');
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            calendarHeader.textContent = `${year}å¹´ ${month + 1}æœˆ`;
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            weekdays.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'font-bold text-sm text-gray-500';
                if (day === 'æ—¥') dayEl.classList.add('text-red-500');
                if (day === 'åœŸ') dayEl.classList.add('text-blue-500');
                calendarGrid.appendChild(dayEl);
            });
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            for (let i = 0; i < firstDay; i++) { calendarGrid.appendChild(document.createElement('div')); }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = i;
                dayEl.className = 'p-2 calendar-day';
                const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                if (attendanceDates.includes(currentDateStr)) { dayEl.classList.add('checked'); }
                if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) { dayEl.classList.add('today'); }
                calendarGrid.appendChild(dayEl);
            }
        }
        
        studyPlusLinkBtn.addEventListener('click', redirectToStudyPlus);
        document.getElementById('prev-month').addEventListener('click', () => { currentMonth.setMonth(currentMonth.getMonth() - 1); updateCalendar(); });
        document.getElementById('next-month').addEventListener('click', () => { currentMonth.setMonth(currentMonth.getMonth() + 1); updateCalendar(); });
        document.getElementById('password').addEventListener('keypress', function(e) { if (e.key === 'Enter') { login(); } });
    </script>
</body>
</html>
