<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>センター南校 登校スタンプラリー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; }
        .calendar-day { transition: all 0.3s ease; }
        .calendar-day.checked { background-color: #fef08a; color: #b45309; font-weight: 800; border-radius: 50%; position: relative; }
        .calendar-day.checked::after { content: '✔'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5em; color: #f59e0b; }
        .calendar-day.today { border: 2px solid #3b82f6; }
        .btn-shine { position: relative; overflow: hidden; }
        .btn-shine::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: rgba(255, 255, 255, 0.4); transform: rotate(45deg); transition: all 0.5s ease; opacity: 0; }
        .btn-shine:hover::after { left: 100%; opacity: 1; transition: all 0.5s ease; }
    </style>
</head>
<body class="bg-blue-50 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8">
        <div id="login-screen">
            <h1 class="text-3xl font-extrabold text-center text-blue-600 mb-2 leading-tight">センター南校<br>登校スタンプラリー</h1>
            <p class="text-center text-gray-500 mb-8">IDとパスワードでログインしてね！</p>
            <div class="space-y-4">
                <input type="text" id="username" placeholder="ID" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                <input type="password" id="password" placeholder="パスワード" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
            </div>
            <button onclick="login()" class="w-full mt-8 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 btn-shine">ログイン</button>
            <p id="login-error" class="text-red-500 text-center mt-4 h-5"></p>
        </div>

        <div id="main-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <div><h2 class="text-2xl font-bold text-gray-800">こんにちは、<span id="user-name"></span> さん！</h2><p class="text-gray-500">今日もがんばろう！</p></div>
                <button onclick="logout()" class="text-sm text-gray-500 hover:text-red-500 transition-colors">ログアウト</button>
            </div>
            
            <div class="bg-blue-100 rounded-lg p-4 text-center mb-6">
                <p class="text-blue-800 text-sm">合計登校日数</p>
                <p class="text-3xl font-extrabold text-blue-600"><span id="login-count">0</span> 日</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <button id="toko-btn" onclick="recordAttendance('toko')" class="bg-green-500 text-white font-bold py-4 rounded-lg hover:bg-green-600 transition-all duration-300 transform hover:scale-105 btn-shine disabled:opacity-50 disabled:cursor-not-allowed">登校する</button>
                <button id="geko-btn" onclick="recordAttendance('geko')" class="bg-orange-500 text-white font-bold py-4 rounded-lg hover:bg-orange-600 transition-all duration-300 transform hover:scale-105 btn-shine disabled:opacity-50 disabled:cursor-not-allowed">下校する</button>
            </div>
            
            <div id="announcements-container" class="space-y-3 mb-6">
            </div>
            
            <div class="mt-2 mb-6">
                <button id="study-plus-link" class="block w-full bg-indigo-500 text-white font-bold py-3 rounded-lg text-center hover:bg-indigo-600 transition-all duration-300 transform hover:scale-105 btn-shine">
                    Study Plusはこちら
                </button>
            </div>

            <div id="calendar" class="bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between items-center mb-4"><button id="prev-month" class="text-gray-600 hover:text-blue-500">&lt;</button><h3 id="calendar-header" class="text-lg font-bold text-gray-700"></h3><button id="next-month" class="text-gray-600 hover:text-blue-500">&gt;</button></div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 設定 ---
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyZRIcKLrM7Y_IxxnjdKb_vFjn9eij2w6lIq7g9lgR90NQHPFF8iomS1TTWVB18M8f5/exec'; // 【重要】ご自身のGASのURLに書き換えてください
        const STUDY_PLUS_BASE_URL = 'https://fs-platform.studyplus.co.jp/auth/student?redirect_uri=https%3A%2F%2Fcontents.studyplus.co.jp%2Fenter_exit%2F6dccd60b94&fallback_uri=https%3A%2F%2Fcontents.studyplus.co.jp%2Faccess_error&expires_at=2025-08-10T09%3A10%3A58.934Z';

        // --- グローバル変数 ---
        let currentUser = null;
        let currentMonth = new Date();
        let attendanceDates = [];
        let hasLeftToday = false;
        let lastCheckedDate = null;
        let loginExpiryTimestamp = null;
        let expiryTimer = null;

        // --- DOM要素 ---
        const loginScreen = document.getElementById('login-screen');
        const mainScreen = document.getElementById('main-screen');
        const loginError = document.getElementById('login-error');
        const userNameEl = document.getElementById('user-name');
        const loginCountEl = document.getElementById('login-count');
        const tokoBtn = document.getElementById('toko-btn');
        const gekoBtn = document.getElementById('geko-btn');
        const studyPlusLinkBtn = document.getElementById('study-plus-link');

        // --- 初期化処理 ---
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const qrLoginDataStr = urlParams.get('qr_login_data');

            if (qrLoginDataStr) {
                try {
                    const decodedData = decodeURIComponent(qrLoginDataStr);
                    const result = JSON.parse(decodedData);
                    showMainScreen(result);
                    window.history.replaceState(null, '', window.location.pathname);
                } catch (e) {
                    console.error("QRログインデータの解析に失敗しました。", e);
                    loginError.textContent = "QRコードのログイン情報が正しくありません。";
                }
            }
        });

        // --- 関数定義 ---
        function showMainScreen(result) {
            currentUser = result.user;
            attendanceDates = result.attendanceDates || [];
            hasLeftToday = result.hasLeftToday || false;
            
            userNameEl.textContent = currentUser.name;
            loginCountEl.textContent = attendanceDates.length;
            
            loginScreen.classList.add('hidden');
            mainScreen.classList.remove('hidden');
            
            const announcementsContainer = document.getElementById('announcements-container');
            announcementsContainer.innerHTML = ''; 

            if (result.announcements && result.announcements.length > 0) {
                let announcementsHtml = '<h3 class="text-xl font-bold text-gray-800 border-b-2 pb-2 mb-2">📢 お知らせ</h3>';
                result.announcements.forEach(ann => {
                    const safeTitle = ann.title.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const safeContent = ann.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    announcementsHtml += `<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg shadow-sm"><h4 class="font-bold text-yellow-900">${safeTitle}</h4><p class="text-gray-700 mt-1 text-sm">${safeContent}</p></div>`;
                });
                announcementsContainer.innerHTML = announcementsHtml;
            }
            
            lastCheckedDate = new Date().toLocaleDateString();

            if (result.expiryTimestamp) {
                loginExpiryTimestamp = result.expiryTimestamp;
                startExpiryTimer();
            }

            updateCalendar();
            updateButtonState();
            loginError.textContent = '';
        }

        function startExpiryTimer() {
            if (expiryTimer) {
                clearInterval(expiryTimer);
            }

            expiryTimer = setInterval(() => {
                if (!loginExpiryTimestamp) {
                    clearInterval(expiryTimer);
                    return;
                }

                const now = new Date().getTime();
                if (now > loginExpiryTimestamp) {
                    alert("セッションの有効期限が切れました。再度ログインしてください。");
                    logout();
                }
            }, 1000);
        }
        
        function checkDateAndLogout() {
            if (!currentUser) return;
            const today = new Date().toLocaleDateString();
            if (lastCheckedDate === null) lastCheckedDate = today;
            if (lastCheckedDate !== today) {
                alert("日付が変わりました。再度ログインしてください。");
                logout();
            }
        }
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                checkDateAndLogout();
            }
        });

        function logout() {
            if (expiryTimer) {
                clearInterval(expiryTimer);
            }
            loginExpiryTimestamp = null;

            currentUser = null;
            attendanceDates = [];
            hasLeftToday = false;
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            mainScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        // --- その他の関数 ---
        function generateDynamicStudyPlusUrl() {
            const originalUrl = new URL(STUDY_PLUS_BASE_URL);
            originalUrl.searchParams.delete('expires_at'); 
            const baseUrlWithoutOldExpiry = originalUrl.toString();
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5);
            const newExpiresAt = now.toISOString();
            return `${baseUrlWithoutOldExpiry}&expires_at=${encodeURIComponent(newExpiresAt)}`;
        }

        function redirectToStudyPlus() {
            window.location.href = generateDynamicStudyPlusUrl();
        }

        // ★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ 変更箇所 1: jsonpRequest 関数を削除 ★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★
        
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ 変更箇所 2: login 関数を fetch (POST) を使う async 関数に変更 ★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            loginError.textContent = 'ログイン中...';
            if (!username || !password) { 
                loginError.textContent = 'IDとパスワードを入力してください。'; 
                return; 
            }

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'login',
                        username: username,
                        password: password
                    })
                });

                if (!response.ok) {
                    throw new Error(`サーバーエラー: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    showMainScreen(result);
                } else {
                    loginError.textContent = result.message || 'ログインに失敗しました。';
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = '通信エラーが発生しました。';
            }
        }

        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ 変更箇所 3: recordAttendance 関数を fetch (POST) を使う async 関数に変更 ★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        async function recordAttendance(type) {
            const button = type === 'toko' ? tokoBtn : gekoBtn;
            button.disabled = true;
            button.textContent = '記録中...';

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'recordAttendance',
                        userId: currentUser.id,
                        type: type
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`サーバーエラー: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    if (type === 'toko') {
                        attendanceDates = result.attendanceDates;
                        loginCountEl.textContent = attendanceDates.length;
                        updateButtonState();
                        updateCalendar();
                        redirectToStudyPlus();  
                    } else if (type === 'geko') {
                        hasLeftToday = true;
                        updateButtonState();
                        redirectToStudyPlus();
                    }
                } else {
                    alert(result.message || '記録に失敗しました。');
                    button.disabled = false;
                }
            } catch (error) {
                console.error('Attendance error:', error);
                alert('記録中に通信エラーが発生しました。');
                button.disabled = false;
            } finally {
                // 成功時はリダイレクトされるが、エラー時やリダイレクト失敗時のためにボタンテキストを戻す
                button.textContent = type === 'toko' ? '登校する' : '下校する';
                // 最終的なボタンの状態を更新
                updateButtonState();
            }
        }

        function updateButtonState() {
            const todayStr = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            const hasAttendedToday = attendanceDates.includes(todayStr);
            tokoBtn.disabled = hasAttendedToday;
            gekoBtn.disabled = !hasAttendedToday || hasLeftToday;
        }

        function updateCalendar() {
            const calendarHeader = document.getElementById('calendar-header');
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            calendarHeader.textContent = `${year}年 ${month + 1}月`;
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            weekdays.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'font-bold text-sm text-gray-500';
                if (day === '日') dayEl.classList.add('text-red-500');
                if (day === '土') dayEl.classList.add('text-blue-500');
                calendarGrid.appendChild(dayEl);
            });
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            for (let i = 0; i < firstDay; i++) { calendarGrid.appendChild(document.createElement('div')); }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = i;
                dayEl.className = 'p-2 calendar-day';
                const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                if (attendanceDates.includes(currentDateStr)) { dayEl.classList.add('checked'); }
                if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) { dayEl.classList.add('today'); }
                calendarGrid.appendChild(dayEl);
            }
        }
        
        // --- イベントリスナー ---
        studyPlusLinkBtn.addEventListener('click', redirectToStudyPlus);
        document.getElementById('prev-month').addEventListener('click', () => { currentMonth.setMonth(currentMonth.getMonth() - 1); updateCalendar(); });
        document.getElementById('next-month').addEventListener('click', () => { currentMonth.setMonth(currentMonth.getMonth() + 1); updateCalendar(); });
        document.getElementById('password').addEventListener('keypress', function(e) { if (e.key === 'Enter') { login(); } });
    </script>
</body>
</html>
